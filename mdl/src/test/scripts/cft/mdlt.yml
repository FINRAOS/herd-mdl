#
# Copyright 2018 herd-mdl contributors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
AWSTemplateFormatVersion: 2010-09-09
Description: MDL - Functional Test
Parameters:
  RollbackOnFailure:
    Default: 'true'
    Type: String
    AllowedValues:
      - 'true'
      - 'false'
    Description: Whether rollback on app stack failure
  MDLInstanceName:
    Default: mdlt
    Description: Application Name:Unique name to be associated with the stack, max length 5 as LB name has 32 chars length limitation
    Type: String
    AllowedPattern: '[a-z0-9]*'
    MaxLength: 5
  ReleaseVersion:
    Default: 1.1.0
    Description: 'Enter the MDL release to use - RC, DEV etc'
    Type: String
  KeyName:
    Default: APP_MDL_PROD
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
  ImageId:
    Default: ami-1853ac65
    Description: AMI id for EC2 instances
    Type: String
  InstanceType:
    Description: Test deploy host EC2 instance type
    Type: String
    Default: t2.medium
  VpcId:
    Description: aws existing VPC Id
    Type: 'AWS::EC2::VPC::Id'
  PublicSubnetId:
    Description: Existing aws subnet id
    Type: 'AWS::EC2::Subnet::Id'
  DeployComponents:
    Type: String
    Default: All
    AllowedValues: [All, Prereqs Only, Herd, Metastor, BDSQL]
    Description: Choose individual MDL components to deploy. Default is All, which will deploy all components
  MdltResultS3BucketName:
     Description: Provide your s3 bucket name if you want to save mdlt results to your s3 bucket, otherwise, mdlt result will be saved to mdlt default bucket
     Type: String
  CertificateArn:
    Description: Certificate Arn for MDL
    Type: String
    Default: arn:aws:acm:us-east-1:328703175456:certificate/f9bd4060-21e8-484a-9f4e-e000da7f29c0
  HostedZoneName:
    Description: Hosted Zone Name to create Route53 record set group for the given domain
    Type: String
    Default: poc.aws.cloudfjord.com.
  DomainNameSuffix:
    Description: Domain name suffix for MDL Domains
    Type: String
    Default: poc.aws.cloudfjord.com
Resources:
  DeployHostHttpsWithAuth:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      # TODO this url should change to git hub location
      # https://github.com/FINRAOS/herd-mdl/releases/download/mdlt-v1.1.0/mdltDeployHost.yml
      TemplateURL: https://s3.amazonaws.com/herd-mdl-deploy-bucket/maggie/mdltDeployHost.yml
      Parameters:
        EnableSSLAndAuth: 'true'
        RollbackOnFailure: !Ref RollbackOnFailure
        MDLInstanceName: !Sub '${MDLInstanceName}httpsauth'
        KeyName: !Ref KeyName
        InstallMdlYmlUrl: https://s3.amazonaws.com/herd-mdl-deploy-bucket/maggie/installMDL.yml
        ReleaseVersion: !Ref ReleaseVersion
        ImageId: !Ref ImageId
        InstanceType: !Ref InstanceType
        VpcId: !Ref VpcId
        PublicSubnetId: !Ref PublicSubnetId
        DeployComponents: !Ref DeployComponents
        MdltResultS3BucketName: !Ref MdltResultS3BucketName
        CertificateArn: !Ref CertificateArn
        HostedZoneName: !Ref HostedZoneName
        DomainNameSuffix: !Ref DomainNameSuffix
  DeployHostHttpWithoutAuth:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: https://s3.amazonaws.com/herd-mdl-deploy-bucket/maggie/mdltDeployHost.yml
      Parameters:
        EnableSSLAndAuth: 'false'
        RollbackOnFailure: !Ref RollbackOnFailure
        MDLInstanceName: !Sub '${MDLInstanceName}httpnauth'
        KeyName: !Ref KeyName
        InstallMdlYmlUrl: https://s3.amazonaws.com/herd-mdl-deploy-bucket/maggie/installMDL.yml
        ReleaseVersion: !Ref ReleaseVersion
        ImageId: !Ref ImageId
        InstanceType: !Ref InstanceType
        VpcId: !Ref VpcId
        PublicSubnetId: !Ref PublicSubnetId
        DeployComponents: !Ref DeployComponents
        MdltResultS3BucketName: !Ref MdltResultS3BucketName
        CertificateArn: ''
        HostedZoneName: ''
        DomainNameSuffix: ''
